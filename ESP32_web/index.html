<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Painel LED via MQTT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="style.css">

<style>
/* ============================
   SEU CSS ORIGINAL
   
============================= */


/* TELA DO MAPA EM TELA CHEIA */
#map-screen {
    display: none;
    width: 100vw;
    height: 100vh;
}

#map {
    width: 100%;
    height: 100%;
}

/* PREVIEW 40×20 */
#previewContainer {
    width: 410px;
    height: 110px;
    border: 3px solid #000000;
    background: rgb(61, 94, 61);
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
    overflow: hidden;
    position: relative;
}

#previewDisplay {
    width: 400px;
    height: 100px;
    overflow: hidden;
    position: relative;
}

#previewText {
    position: absolute;
    white-space: nowrap;
    font-family: monospace;
    font-weight: bold;
}

@keyframes scroll20x40 {
    0% { transform: translateX(400px); }
    100% { transform: translateX(-800px); }
}

/* MARCADOR OFFLINE */
.marker-offline {
    filter: grayscale(100%) brightness(60%);
}

.form-box {
    padding: 20px;
}
.myButton {
    padding: 8px 18px;
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="form-box">
  <h1>Login</h1>
  <label>Usuário:</label>
  <input type="text" id="login_user" placeholder="Digite seu usuário">
  <label>Senha:</label>
  <input type="password" id="login_pass" placeholder="Digite sua senha">
  <button class="myButton" onclick="fazerLogin()">Entrar</button>
</div>

<!-- MAPA -->
<div id="map-screen">
  <div id="map"></div>
</div>

<!-- CONFIGURAÇÃO DO DISPOSITIVO -->
<div id="control-screen" class="form-box" style="display:none;">
  <h1>Configuração: <span id="selectedDevice"></span></h1>

  <label>Texto:</label>
  <input type="text" id="input_Scrolling_Text" oninput="atualizarPreview()">

  <label>Brilho:</label>
  <input type="number" id="input_Brightness" value="50" min="0" max="255">

  <label>Cor do Texto:</label>
  <input type="color" id="input_Color" value="#FFFFFF" onchange="atualizarPreview()">

  <label>Cor de Fundo:</label>
  <input type="color" id="input_Background" value="#000000" onchange="atualizarPreview()">

  <label>Tamanho:</label>
  <select id="input_Text_Size" onchange="atualizarPreview()">
    <option value="1">1</option>
    <option value="2" selected>2</option>
    <option value="3">3</option>
  </select>

  <label>Posição Y:</label>
  <select id="input_Y_Position" onchange="atualizarPreview()">
    <option value="2">Topo</option>
    <option value="6">Alto</option>
    <option value="9">Centro</option>
    <option value="13">Baixo</option>
    <option value="16">Inferior</option>
  </select>

  <label>Modo:</label>
  <select id="input_Mode" onchange="atualizarPreview()">
    <option value="scroll">Rolante</option>
    <option value="fixed">Fixo</option>
  </select>

  <label>Velocidade:</label>
  <select id="input_Scrolling_Speed" onchange="atualizarPreview()">
    <option value="15">20</option>
    <option value="40">40</option>
    <option value="60">60</option>
  </select>

  <h3>Preview 40×20</h3>
  <div id="previewContainer">
      <div id="previewDisplay">
          <span id="previewText"></span>
      </div>
  </div>

  <button class="myButton" onclick="enviar()">Enviar</button>
</div>

<script>
let map;
let marcador;
let dispositivoOnline = false;
let dispositivoSelecionado = "";

// posição padrão
let ultimoPonto = { lat: -23.6293, lng: -46.6351 };

/* ============================================================
                    LOGIN → Mapa
============================================================ */
function fazerLogin() {
    let u = document.getElementById("login_user").value.trim();
    let s = document.getElementById("login_pass").value.trim();
    if (!u || !s) return;

    document.getElementById("login-screen").style.display = "none";
    document.getElementById("map-screen").style.display = "block";
}

/* ============================================================
                         MAPA
============================================================ */
function initMap() {

    map = L.map('map').setView([ultimoPonto.lat, ultimoPonto.lng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    marcador = L.marker([ultimoPonto.lat, ultimoPonto.lng]).addTo(map);

    marcador.on("click", () => {
        if (!dispositivoOnline) {
            alert("❌ O dispositivo está OFFLINE.\nNão é possível abrir as configurações.");
            return;
        }
        abrirConfiguracao();
    });
}

function abrirConfiguracao() {
    document.getElementById("map-screen").style.display = "none";
    document.getElementById("control-screen").style.display = "block";
    document.getElementById("selectedDevice").innerText = "Painel LED";
}

/* ============================================================
                         MQTT
============================================================ */
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

client.on("connect", () => {
    console.log("MQTT conectado");
    client.subscribe("painel/localizacao");
});

client.on("message", (topic, message) => {
    let data = JSON.parse(message.toString());

    if (!data.lat || !data.lng) return;

    ultimoPonto = { lat: data.lat, lng: data.lng };
    dispositivoOnline = true;

    marcador.setLatLng([data.lat, data.lng]);
    marcador._icon.classList.remove("marker-offline");
});

setInterval(() => {
    if (!dispositivoOnline) {
        marcador._icon.classList.add("marker-offline");
    }
    dispositivoOnline = false;
}, 8000);

/* ============================================================
                        PREVIEW
============================================================ */
function atualizarPreview() {
    const txt = document.getElementById("input_Scrolling_Text").value;
    const cor = document.getElementById("input_Color").value;
    const fundo = document.getElementById("input_Background").value;
    const tam = document.getElementById("input_Text_Size").value;
    const modo = document.getElementById("input_Mode").value;
    const vel = document.getElementById("input_Scrolling_Speed").value;
    const ypos = document.getElementById("input_Y_Position").value;

    const previewText = document.getElementById("previewText");
    const preview = document.getElementById("previewDisplay");

    preview.style.background = fundo;
    previewText.style.color = cor;
    previewText.textContent = txt;

    previewText.style.fontSize = (tam == 1 ? 12 : tam == 2 ? 18 : 26) + "px";
    previewText.style.top = (ypos * 2) + "px";

    previewText.style.animation = "none";
    if (modo === "scroll")
        previewText.style.animation = `scroll20x40 ${vel/8}s linear infinite`;
}

/* ============================================================
                        ENVIAR MQTT
============================================================ */
function enviar() {
    alert("Mensagem enviada! (implementar payload depois)");
}

/* INIT */
window.onload = initMap;
</script>

</body>
</html>
