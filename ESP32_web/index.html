<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Painel LED via MQTT</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<!-- Leaflet Mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
#map-screen {
    display: none;
    width: 100vw;
    height: 100vh;
}
#map {
    width: 100%;
    height: 100%;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="form-box">
  <h1>Login</h1>
  <label>Usu치rio:</label>
  <input type="text" id="login_user" placeholder="Digite seu usu치rio">

  <label>Senha:</label>
  <input type="password" id="login_pass" placeholder="Digite sua senha">

  <button class="myButton" onclick="fazerLogin()">Entrar</button>
</div>

<!-- MAPA -->
<div id="map-screen">
  <div id="map"></div>
</div>

<!-- CONFIGURA칂츾O -->
<div id="control-screen" class="form-box" style="display:none;">
  <h1>Configura칞칚o: <span id="selectedDevice"></span></h1>

  <label>Texto:</label>
  <input type="text" id="input_Scrolling_Text" maxlength="100" oninput="atualizarPreview()">

  <label>Brilho:</label>
  <input type="number" id="input_Brightness" value="50" min="0" max="255">

  <label>Cor do Texto:</label>
  <input type="color" id="input_Color" value="#FFFFFF" onchange="atualizarPreview()">

  <label>Cor de Fundo:</label>
  <input type="color" id="input_Background" value="#000000" onchange="atualizarPreview()">

  <label>Tamanho:</label>
  <select id="input_Text_Size" onchange="atualizarPreview()">
    <option value="1" selected>Arial7</option>
    <option value="2">Arial8</option>
    <option value="3">Arial9</option>
  </select>

  <label>Posi칞칚o Y:</label>
  <select id="input_Y_Position" onchange="atualizarPreview()">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="7">7</option>
  </select>

  <label>Modo:</label>
  <select id="input_Mode" onchange="atualizarPreview()">
    <option value="scroll">Rolante</option>
    <option value="fixed">Fixo</option>
  </select>

  <label>Velocidade:</label>
  <select id="input_Scrolling_Speed" onchange="atualizarPreview()">
    <option value="15">20</option>
    <option value="40">40</option>
    <option value="60">60</option>
  </select>

  <h3>Preview 40칑20</h3>
  <div id="previewContainer">
      <div id="previewDisplay">
          <span id="previewText"></span>
      </div>
  </div>

  <button class="myButton" onclick="enviar()">Enviar</button>
</div>

<script>
let client = null;
let meuUsuario = '';
let minhaSenha = '';
let dispositivos = {};
let markers = {};
let lastUpdate = {};
let mapa = null;
let dispositivoSelecionado = "";

/* 칈CONES ONLINE/OFFLINE */
const iconOnline = L.icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
    iconSize: [25, 41],
    iconAnchor: [12, 41]
});
const iconOffline = L.icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
    iconSize: [25, 41],
    iconAnchor: [12, 41]
});

/* LOGIN */
function fazerLogin() {
    meuUsuario = document.getElementById("login_user").value.trim();
    minhaSenha = document.getElementById("login_pass").value.trim();

    if (!meuUsuario || !minhaSenha) return;

    document.getElementById("login-screen").style.display = "none";
    document.getElementById("map-screen").style.display = "block";

    setTimeout(() => iniciarMapa(), 100); // CORRE칂츾O
    conectarMQTT();
}

/* MAPA */
function iniciarMapa() {
    mapa = L.map('map').setView([-15.78, -47.93], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
}

function atualizarMapa() {
    const agora = Date.now();

    for (let nome in dispositivos) {
        let d = dispositivos[nome];

        if (!d.lat || !d.lng) continue;

        const online = (agora - lastUpdate[nome] < 30000);
        const pos = [d.lat, d.lng];

        if (!markers[nome]) {
            markers[nome] = L.marker(pos, {
                icon: online ? iconOnline : iconOffline
            })
            .addTo(mapa)
            .on("click", () => abrirConfiguracao(nome))
            .bindPopup(`<b>${nome}</b><br>${online ? "游릭 Online" : "游댮 Offline"}`);
        } else {
            markers[nome].setLatLng(pos);
            markers[nome].setIcon(online ? iconOnline : iconOffline);
            markers[nome].setPopupContent(`<b>${nome}</b><br>${online ? "游릭 Online" : "游댮 Offline"}`);
        }
    }
}

/* ABRIR CONFIGURA칂츾O */
function abrirConfiguracao(nome) {
    dispositivoSelecionado = nome;
    document.getElementById("map-screen").style.display = "none";
    document.getElementById("control-screen").style.display = "block";
    document.getElementById("selectedDevice").innerText = nome;
}

/* MQTT */
function conectarMQTT() {
    client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

    client.on("connect", () => {
        client.subscribe("painel_led_dispositivos");
    });

    client.on("message", (topic, message) => {
        if (topic !== "painel_led_dispositivos") return;

        let doc = JSON.parse(message.toString());

        if (doc.user !== meuUsuario) return;

        dispositivos[doc.name] = doc;
        lastUpdate[doc.name] = Date.now();

        atualizarMapa();
    });

    setInterval(atualizarMapa, 5000);
}

/* PREVIEW */
function atualizarPreview() {
    const preview = document.getElementById("previewText");
    const box = document.getElementById("previewDisplay");

    preview.style.color = input_Color.value;
    box.style.background = input_Background.value;
    preview.textContent = input_Scrolling_Text.value;

    preview.style.fontSize =
        (input_Text_Size.value == 1 ? 12 : input_Text_Size.value == 2 ? 18 : 26) + "px";

    preview.style.top = (input_Y_Position.value * 10) + "px";
}

/* ENVIAR */
function enviar() {
    if (!dispositivoSelecionado)
        return alert("Nenhum dispositivo selecionado!");

    let payload = {
        destino: dispositivoSelecionado,
        user: meuUsuario,
        pass: minhaSenha,
        texto: input_Scrolling_Text.value,
        brilho: parseInt(input_Brightness.value),
        cor: hexToRgb(input_Color.value),
        corFundo: hexToRgb(input_Background.value),
        tamanho: parseInt(input_Text_Size.value),
        ypos: parseInt(input_Y_Position.value),
        modo: input_Mode.value,
        velocidade: parseInt(input_Scrolling_Speed.value)
    };

    client.publish("painel_led_test", JSON.stringify(payload));
}

function hexToRgb(hex) {
    let num = parseInt(hex.replace("#", ""), 16);
    return [(num>>16)&255, (num>>8)&255, num&255];
}
</script>

</body>
</html>
